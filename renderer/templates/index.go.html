{{ define "home" }}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shrike â€“ Quick Jobs</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 20px;
      }
      nav {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(260px, 1fr));
        gap: 16px;
      }
      .card {
        background: #232323;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 16px;
      }
      .card h3 {
        margin: 0 0 8px 0;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #555;
        background: #333;
        color: #d4d4d4;
        font-weight: bold;
      }
      .btn-primary {
        background: #61dafb;
        color: #000;
        border-color: #61dafb;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 4px;
        border: 1px solid #333;
        background-color: #111;
        color: #d4d4d4;
        font-family: monospace;
        font-size: 14px;
        box-sizing: border-box;
      }
      label {
        color: #aaa;
      }
      @media screen and (max-width: 800px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Quick Jobs</h1>
      {{ template "topnav" . }}

      <div class="grid" style="margin-top: 12px">
        <div class="card">
          <h3>Ingest media from path</h3>
          <p style="color: #aaa; margin: 4px 0 8px 0">
            Enter a local folder path to scan and ingest media files.
          </p>
          <div class="row" style="margin-bottom: 8px">
            <input
              class="input"
              id="ingestPath"
              name="ingestPath"
              list="pathdir-suggestions"
              placeholder="e.g. C:\Media\New"
            />
            <datalist id="pathdir-suggestions"></datalist>
          </div>
          <div class="row" style="margin-bottom: 12px">
            <label for="ingestRecursive" style="display: inline-flex; gap: 6px"
              ><input type="checkbox" id="ingestRecursive" /> Scan
              recursively</label
            >
          </div>
          <div class="row">
            <button class="btn btn-primary" onclick="createIngestJob()">
              Start ingest
            </button>
          </div>
          <div id="ingestStatus" style="color: #aaa; margin-top: 8px"></div>
        </div>

        <div class="card">
          <h3>Generate transcripts (missing only)</h3>
          <p style="color: #aaa; margin-top: 4px">
            Create a job to generate transcripts for items without one.
          </p>
          <button class="btn btn-primary" onclick="createTranscriptsJob()">
            Start transcripts job
          </button>
        </div>

        <div class="card">
          <h3>Generate descriptions (missing only)</h3>
          <p style="color: #aaa; margin-top: 4px">
            Create a job to generate descriptions for items with none.
          </p>
          <button class="btn btn-primary" onclick="createDescriptionsJob()">
            Start descriptions job
          </button>
        </div>

        <div class="card">
          <h3>Auto-tag with ONNX tagger (untagged images)</h3>
          <p style="color: #aaa; margin-top: 4px">
            Use the ONNX tagger to add Suggested tags where none exist.
          </p>
          <button class="btn btn-primary" onclick="createOnnxAutotagJob()">
            Start ONNX auto-tag
          </button>
        </div>

        <div class="card">
          <h3>Cleanup database (remove orphans)</h3>
          <p style="color: #aaa; margin-top: 4px">
            Remove media entries whose files are missing from disk.
          </p>
          <button class="btn btn-primary" onclick="createCleanupJob()">
            Start cleanup
          </button>
        </div>
      </div>

      <div style="margin-top: 20px; color: #aaa">
        View progress in <a href="/jobs" style="color: #61dafb">Jobs</a>.
      </div>
    </div>

    <script>
      function b64(s) {
        return btoa(unescape(encodeURIComponent(s)));
      }
      function postCreate(input) {
        return fetch("/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input }),
        }).then((r) => {
          if (!r.ok) throw new Error("request failed");
          return r.json();
        });
      }
      function createTranscriptsJob() {
        const query = 'transcript:""';
        const args = "--type transcript --apply all --query64=" + b64(query);
        postCreate(`metadata ${args}`)
          .then((res) => {
            alert("Transcripts job created: " + res.id);
          })
          .catch((err) => alert("Error: " + err.message));
      }
      function createDescriptionsJob() {
        const query = 'description:""';
        const args = "--type description --apply all --query64=" + b64(query);
        postCreate(`metadata ${args}`)
          .then((res) => {
            alert("Descriptions job created: " + res.id);
          })
          .catch((err) => alert("Error: " + err.message));
      }
      function createOnnxAutotagJob() {
        const query = "tags:none";
        const args = "--query64=" + b64(query);
        postCreate(`autotag ${args}`)
          .then((res) => {
            alert("ONNX autotag job created: " + res.id);
          })
          .catch((err) => alert("Error: " + err.message));
      }
      function createIngestJob() {
        const statusEl = document.getElementById("ingestStatus");
        const path = (document.getElementById("ingestPath").value || "").trim();
        const recursive = document.getElementById("ingestRecursive").checked;
        if (!path) {
          statusEl.style.color = "#e06c75";
          statusEl.textContent = "Please enter a folder path.";
          return;
        }
        statusEl.style.color = "#aaa";
        statusEl.textContent = "Creating ingest job...";
        const args = (recursive ? "--recursive " : "") + `"${path}"`;
        postCreate(`ingest ${args}`)
          .then((res) => {
            statusEl.style.color = "#aaa";
            statusEl.textContent = "Ingest job created: " + res.id;
          })
          .catch((err) => {
            statusEl.style.color = "#e06c75";
            statusEl.textContent = "Error: " + err.message;
          });
      }
      function createCleanupJob() {
        postCreate("cleanup")
          .then((res) => {
            alert("Cleanup job created: " + res.id);
          })
          .catch((err) => alert("Error: " + err.message));
      }
      // Populate directory suggestions
      (function loadPathDirSuggestions() {
        fetch("/media/suggest?kind=pathdir&limit=50")
          .then((r) => r.json())
          .then((data) => {
            const list = document.getElementById("pathdir-suggestions");
            if (!list || !Array.isArray(data.suggestions)) return;
            list.innerHTML = "";
            data.suggestions.forEach((p) => {
              const opt = document.createElement("option");
              opt.value = p;
              list.appendChild(opt);
            });
          })
          .catch(() => {});
      })();
    </script>
  </body>
</html>
{{ end }}
